name: Build libvips for macOS (with PDF)

on:
  push:
    paths:
      - ".github/workflows/build-libvips-macos.yml"
  pull_request:
    paths:
      - ".github/workflows/build-libvips-macos.yml"
  workflow_dispatch:

jobs:
  build:
    name: libvips 8.18.0 on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-13]

    env:
      VIPS_VERSION: 8.18.0
      PREFIX: /usr/local/libvips

    steps:
      - name: Checkout (not strictly required, but nice to have)
        uses: actions/checkout@v4

      - name: Cache Homebrew downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-${{ matrix.os }}-brew-${{ hashFiles('.github/workflows/build-libvips-macos.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.os }}-brew-

      - name: Install build deps (Homebrew)
        run: |
          set -euxo pipefail
          export HOMEBREW_NO_AUTO_UPDATE=1

          brew update

          # Build tooling
          brew install meson ninja pkgconf gettext gobject-introspection

          # Core deps / common loaders
          brew install glib libpng jpeg-turbo libtiff webp openjpeg little-cms2 libexif

          # Text/SVG rendering (often expected)
          brew install cairo pango librsvg fontconfig freetype

          # "Everything-ish" extras (optional features that are commonly useful)
          brew install libheif libarchive cgif libimagequant openslide libraw

          # PDF support (poppler-glib is required by libvips for pdfload)
          brew install poppler

          echo "== Tool versions =="
          meson --version
          ninja --version
          pkgconf --version
          brew list --versions poppler vips || true

          echo "== pkg-config sanity for poppler-glib =="
          pkgconf --modversion poppler-glib

      - name: Download libvips source
        run: |
          set -euxo pipefail
          # GitHub tag tarball (doesn't depend on release assets)
          curl -L --retry 3 -o "vips-${VIPS_VERSION}.tar.gz" \
            "https://github.com/libvips/libvips/archive/refs/tags/v${VIPS_VERSION}.tar.gz"
          tar -xzf "vips-${VIPS_VERSION}.tar.gz"
          mv "libvips-${VIPS_VERSION}" src

      - name: Configure (Meson)
        run: |
          set -euxo pipefail
          cd src

          # Make sure pkg-config finds brewed .pc files
          BREW_PREFIX="$(brew --prefix)"
          export PKG_CONFIG_PATH="${BREW_PREFIX}/lib/pkgconfig:${BREW_PREFIX}/share/pkgconfig:${PKG_CONFIG_PATH:-}"

          meson setup build \
            --prefix="${PREFIX}" \
            --libdir=lib \
            --buildtype=release \
            -Dintrospection=true

      - name: Build
        run: |
          set -euxo pipefail
          cd src
          meson compile -C build

      - name: Verify PDF support + smoke test
        run: |
          set -euxo pipefail
          cd src

          VIPS_BIN="./build/tools/vips/vips"

          "${VIPS_BIN}" --version
          "${VIPS_BIN}" --vips-config | grep -E 'PDF load|poppler' || true

          # Hard requirement: poppler-glib must be enabled
          "${VIPS_BIN}" --vips-config | grep -q 'PDF load with poppler-glib: yes'

          # Smoke test: render a PDF page -> PNG
          curl -L --retry 3 -o sample.pdf \
            "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf"
          "${VIPS_BIN}" copy "sample.pdf[page=0]" out.png
          file out.png

      - name: Install to staging (DESTDIR) + package tarball
        run: |
          set -euxo pipefail
          cd src

          rm -rf stage
          mkdir -p stage

          # Stage install into ./stage + PREFIX inside it
          DESTDIR="$PWD/stage" meson install -C build

          # Package result
          OUTDIR="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$OUTDIR"

          ART="libvips-${VIPS_VERSION}-${{ matrix.os }}.tar.gz"
          (cd stage && tar -czf "$OUTDIR/$ART" .)

          # Checksums + manifest
          shasum -a 256 "$OUTDIR/$ART" > "$OUTDIR/$ART.sha256"

          # Helpful text file: how to use
          cat > "$OUTDIR/USAGE-${{ matrix.os }}.txt" <<EOF
          Extract anywhere, then set:
            export VIPS_PREFIX="<extract_root>${PREFIX}"
            export PATH="\$VIPS_PREFIX/bin:\$PATH"
            export DYLD_LIBRARY_PATH="\$VIPS_PREFIX/lib:\$DYLD_LIBRARY_PATH"

          Then test:
            vips --version
            vips --vips-config | grep -E 'PDF load|poppler'
            vips copy "file.pdf[page=0]" out.png
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libvips-8.18.0-${{ matrix.os }}
          path: artifacts
